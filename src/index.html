<!DOCTYPE html>
<html lang="en">
<head>
  <title>Bitmovin Player Yospace Integration Test Page</title>
  <meta charset="UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bitmovin Player -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha256-3edrmyuQ0w65f8gfBsqowzjJe2iM6n0nKciPUp8y+7E=" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

  <script type="text/javascript" src="../yospace/yo-ad-management.min.js"></script>
  <script type="text/javascript" src="js/bitmovin-player-yospace.js"></script>

  <script type="text/javascript" src="//cdn.bitmovin.com/player/web/8.5.0/bitmovinplayer-ui.js"></script>
  <link rel="stylesheet" href="//cdn.bitmovin.com/player/web/8.5.0/bitmovinplayer-ui.css">
  <style>
    .player-wrapper {
      margin: 20px auto;
      box-shadow: 0 0 30px rgba(0,0,0,0.7);
    }
    .meta-info {
      text-align: center;
    }
    .row {
      margin: 20px 0;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="meta-info">
    <div class="row">
      <div class="col-12">
        <div class="btn-group btn-group-toggle" data-toggle="buttons">
          <label class="btn btn-outline-secondary active">
            <input type="radio" name="options" id="option-vod" autocomplete="off" checked>Load VOD
          </label>
          <label class="btn btn-outline-secondary">
            <input type="radio" name="options" id="option-vod-vpaid" autocomplete="off" checked>Load VOD + VPAID
          </label>
          <label class="btn btn-outline-secondary">
            <input type="radio" name="options" id="option-live" autocomplete="off">Load Live
          </label>
          <label class="btn btn-outline-secondary">
            <input type="radio" name="options" id="option-aom" autocomplete="off">Art of motion
          </label>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <div class="input-group mb-3">
          <input id="steam-stream-url" type="text" class="form-control" placeholder="Custom Stream URL" aria-label="Custom Stream URL">
          <select class="custom-select col-2" id="stream-type-select">
            <option value="1" selected>VoD</option>
            <option value="2">Live</option>
            <option value="3">None</option>
          </select>
          <div class="input-group-append">
            <button id="load-custom-steam" class="btn btn-outline-secondary" type="button">Load</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="content">
    <div class="player-wrapper">
      <div id="player"></div>
    </div>
  </div>
  <div id="companionDiv" style="width:728px; height:90px;">
  </div>
</div>
<script type="text/javascript">
  var yospacePlayer;

  var vodButton = $('#option-vod').parent();
  var vodVpaidButton = $('#option-vod-vpaid').parent();
  var liveButton = $('#option-live').parent();
  var artOfMotionButton = $('#option-aom').parent();
  var customStreamButton = $('#load-custom-steam');
  var customStreamTypeSelect = $('#stream-type-select');

  function deselectCustomLoadButton() {
    $(customStreamButton).removeClass('active');
  }

  vodButton.on('click', function() {
    vodButton.button('toggle');
    deselectCustomLoadButton();

    yospacePlayer.unload();
    yospacePlayer.load(vodSource);
  });

  vodVpaidButton.on('click', function() {
    vodVpaidButton.button('toggle');
    deselectCustomLoadButton();

    yospacePlayer.unload();
    yospacePlayer.load(vodVpaidSource);
  });

  liveButton.on('click', function() {
    liveButton.button('toggle');
    deselectCustomLoadButton();

    yospacePlayer.unload();
    yospacePlayer.load(liveSource);
  });

  artOfMotionButton.on('click', () => {
    artOfMotionButton.button('toggle');
    deselectCustomLoadButton();

    yospacePlayer.unload();
    yospacePlayer.load(artOfMotionSource).then(() => {
      console.log('[log] Non yospace source loaded');
    }).catch(() => {
      console.log('[log] Loading non yospace source failed');
    });
  })

  customStreamButton.on('click', function() {
    $(customStreamButton).addClass('active');

    // remove active button of group
    $($('.btn-group-toggle .active')[0]).removeClass('active');
    var customSource = {
      title: 'Custom Stream',
      hls: $('#steam-stream-url').val(),
    };

    if (customStreamTypeSelect.val() === '1') {
      customSource.assetType = bitmovin.player.ads.yospace.YospaceAssetType.VOD;
    } else if (customStreamTypeSelect.val() === '2') {
      customSource.assetType = bitmovin.player.ads.yospace.YospaceAssetType.LINEAR;
    }

    yospacePlayer.unload();
    yospacePlayer.load(customSource);
  });

  var liveSource = {
    title: 'Live Stream',
    hls: ' https://ssai.cdn.turner.com/csmp/cmaf/live/2000073/tbse-clear/master.m3u8?yo.aas=true&yo.av=2&yo.ch=true&yo.ac=true&yo.ad=true&yo.po=-4',

    // Yospace configuration
    assetType: bitmovin.player.ads.yospace.YospaceAssetType.LINEAR
  };

  var vodSource = {
    title: 'VOD Stream',
    hls: 'https://csm-e-stg.tls1.yospace.com/csm/access/525947592/cWEvY21hZl9hZHZhbmNlZF9mbXA0X2Zyb21faW50ZXIvcHJvZ19zZWcvbXdjX0NBUkUxMDA5MjYxNzAwMDE4ODUyL2NsZWFyLzNjM2MzYzNjM2MzYzNjM2MzYzNjM2MzYzNjM2MzYzNjL21hc3Rlcl9jbF9ub19pZnJhbWUubTN1OA==?yo.av=2&yo.ad=true',
    // hls: 'http://csm-e.cds1.yospace.com/access/d/400/u/0/1/130782300?f=0000130753172&format=vmap',

    // Yospace configuration
    assetType: bitmovin.player.ads.yospace.YospaceAssetType.VOD,
    // options: {
    //   startOffset: 600
    // }
  };

  var vodVpaidSource = {
    title: 'VOD Stream',
    hls: 'https://turnercmaf.warnermediacdn.com/csm/qa/cmaf_advanced_fmp4_from_inter/prog_seg/bones_RADS1008071800025944_v12/clear/3c3c3c3c3c3c3c3c3c3c3c3c3c3c3c3c/master_cl_ifp.m3u8?context=525951113',

    // Yospace configuration
    assetType: bitmovin.player.ads.yospace.YospaceAssetType.VOD
  };

  var artOfMotionSource = {
    title: 'Art Of Motion',
    hls: '//bitdash-a.akamaihd.net/content/MI201109210084_1/m3u8s/f08e80da-bf1d-4e3d-8899-f0f6155f6efa.m3u8',

    // No Yospace config
  };

  var conf = {
    key: '18ca6ad5-9768-4129-bdf6-17685e0d14d2',
    playback: {
      muted: true,
      autoplay: true
    },
    ui: false,
  };

  // Yospace configuration
  var yospaceConfig = {
      debug: true
  };

  var sampleYospacePlayerPolicy = {
    canMute: () => {
      return true;
    },
    canSeek: () => {
      return true;
    },
    canSeekTo: (seekTarget) => {
      return seekTarget;
    },
    canSkip: () => {
      return true;
    },
    canPause: () => {
      return true;
    },
    canChangePlaybackSpeed: () => {
      return true;
    },
  };

  var playerContainer = document.getElementById('player');
  yospacePlayer = new bitmovin.player.ads.yospace.BitmovinYospacePlayer(playerContainer, conf, yospaceConfig);

  bitmovin.playerui.UIFactory.buildDefaultUI(yospacePlayer);

  yospacePlayer.load(vodSource).then(function() {
      console.log('Source successfully loaded');
  }).catch(function() {
      console.log('Error while loading the source');
  });

  yospacePlayer.on('yospaceerror', function(event) {
    console.error(event);
  })

  yospacePlayer.on('adbreakstarted', function(event) {
    console.debug(event);
  })

  yospacePlayer.on('adstarted', function(event) {
    console.debug('Ad Started' + JSON.stringify(event));

    if (event.ad && event.ad.companionAds && event.ad.companionAds.length > 0) {
      var img = new Image(event.ad.companionAds[0].width,event.ad.companionAds[0].height)
      img.src = event.ad.companionAds[0].staticResource
      document.getElementById("companionDiv").appendChild(img)
    }
  })

  yospacePlayer.on('adfinished', function(event) {
    console.debug('Ad Finished: ' + JSON.stringify(event));
    var companion = document.getElementById("companionDiv")
    while (companion.firstChild) {
      companion.removeChild(companion.firstChild);
    }
  })

</script>
</body>
</html>
