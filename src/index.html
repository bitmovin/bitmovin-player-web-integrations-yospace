<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Bitmovin Player Yospace Integration Test Page</title>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Bitmovin Player -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>

    <script type="text/javascript" src="js/bitmovin-player-yospace.js"></script>

    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-core.js"></script>
    <script
      type="text/javascript"
      src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-polyfill.js"
    ></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-style.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-xml.js"></script>
    <script
      type="text/javascript"
      src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-advertising-core.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-advertising-bitmovin.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-mserenderer.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-engine-bitmovin.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-container-mp4.js"
    ></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-hls.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-dash.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-abr.js"></script>
    <script
      type="text/javascript"
      src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-container-ts.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-engine-native.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-serviceworker-client.js"
    ></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-tizen.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-webos.js"></script>

    <script type="text/javascript" src="//cdn.bitmovin.com/player/web/8/bitmovinplayer-ui.js"></script>
    <link rel="stylesheet" href="//cdn.bitmovin.com/player/web/8/bitmovinplayer-ui.css" />
    <style>
      .player-wrapper {
        margin: 20px auto;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
      }

      .meta-info {
        text-align: center;
      }

      .row {
        margin: 20px 0;
      }

      #companionDiv {
        width: 728px;
        height: 90px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="meta-info">
        <div class="row">
          <div class="col-12">
            <div class="btn-group btn-group-toggle" data-toggle="buttons">
              <label class="btn btn-outline-secondary">
                <input type="radio" name="options" id="option-close" autocomplete="off" checked />Close Player
              </label>
              <label class="btn btn-outline-secondary active">
                <input type="radio" name="options" id="option-vod" autocomplete="off" checked />Yospace VOD
              </label>
              <label class="btn btn-outline-secondary">
                <input type="radio" name="options" id="option-live" autocomplete="off" />Yospace Live
              </label>
              <label class="btn btn-outline-secondary">
                <input type="radio" name="options" id="option-aom" autocomplete="off" />Art of motion
              </label>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <div class="input-group mb-3">
              <input
                id="steam-stream-url"
                type="text"
                class="form-control"
                placeholder="Custom Stream URL"
                aria-label="Custom Stream URL"
              />
              <select class="custom-select col-2" id="stream-type-select">
                <option value="1">VoD</option>
                <option value="2">Live</option>
                <option value="3">None</option>
              </select>
              <div class="input-group-append">
                <button id="load-custom-steam" class="btn btn-outline-secondary" type="button">Load</button>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="input-group mb-3">
              <select class="custom-select col-12" id="tearsheet-override">
                <option value="0" selected>Override Ad Tearsheet</option>
                <option value="55085793" data-id="141403_CNN_Fuji_VPAID_30s_307518956_6.30">
                  55085793 - Fuji Film 30s
                </option>
                <option value="54510215" data-id="139334_CNN_Invesco_Markets_VPAID_15s_306893272_6.28.21">
                  54510215 - Invesco Limited 15s
                </option>
                <option value="54510215" data-id="139334_CNN_Invesco_Markets_VPAID_15s_306893272_6.28.21">
                  54510215 - Invesco Limited 30s
                </option>
                <option value="52125737" data-id="138227_CNN_IBM CA Cash_Desktop_15s_VPAID_289436970_NEW_2.25.21">
                  52125737 - IBM Corp 15s
                </option>
                <option value="54476788" data-id="141744_CNN_Farmers_Q3_15s_VPAID_2371065_6.24.21">
                  54476788 - Farmers 15s
                </option>
                <option value="54476788" data-id="141744_CNN_Farmers_Q3_30s_VPAID_2371066_6.24.21">
                  54476788 - Farmers 30s
                </option>
                <option value="50323493" data-id="138527_CNN_ROS_Tobacco_Free_Kids_293007205_VPAID_30s_1.7">
                  50323493 - Tobacco Free Kids 30s
                </option>
                <option value="49929643" data-id="138222_CNN_IBM CA_VPAID_289542595_15s_NEW_2.25.21">
                  49929643 - IBM Corp-2 30s
                </option>
                <option value="55085793" data-id="141403_CNN_Fuji_Vpaid_with_mp4_30_307581174_7.1">
                  55085793 - Fuji Film-2 30s
                </option>
                <option value="51153356" data-id="141403_CNN_Fuji_Vpaid_with_mp4_30_307581174_7.1">
                  51153356 - Association of AM Railroads 15s
                </option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <div class="content">
        <div class="player-wrapper">
          <div id="player"></div>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <p1 id="segmentPlaybackLabel">Playing Segment: unknown</p1>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <p1 id="adBreakLabel">AdBreak: false</p1>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <p1 id="adLabel">Ad: false</p1>
        </div>
      </div>

      <div class="row">
        <table class="table" id="adEventTable"></table>
      </div>

      <div class="row">
        <table class="table" id="adTable"></table>
      </div>
      <div class="row">
        <div id="companionDiv"></div>
      </div>
    </div>
    <script type="text/javascript">
      var yospacePlayer;

      var closePlayerButton = $('#option-close').parent();
      var vodButton = $('#option-vod').parent();
      var trueXButton = $('#option-vod-truex').parent();
      var liveButton = $('#option-live').parent();
      var artOfMotionButton = $('#option-aom').parent();
      var customStreamButton = $('#load-custom-steam');
      var customStreamTypeSelect = $('#stream-type-select');

      function log(message) {
        if (isValidationMode) return;
        console.log(message);
      }

      function debug(message) {
        if (isValidationMode) return;
        console.debug(message);
      }

      function unregisterAllServiceWorker() {
        if (navigator.serviceWorker) {
          return navigator.serviceWorker.getRegistrations().then((registrations) => {
            return Promise.all(registrations.map((registration) => registration.unregister())).then(() => {
              // ensure Promise<void> is returned
            });
          });
        } else {
          return Promise.resolve();
        }
      }

      var unregisterServiceWorkersPromise = unregisterAllServiceWorker();

      $.urlParam = function (name) {
        var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
        if (results == null) {
          return null;
        } else {
          return decodeURI(results[1]) || 0;
        }
      };

      var isValidationMode = false;
      if ($.urlParam('validation')) {
        isValidationMode = $.urlParam('validation').toLowerCase() === 'true';
      }

      var debugOverride = true;
      if ($.urlParam('debug')) {
        debugOverride = $.urlParam('debug').toLowerCase() === 'true';
      }

      var autoplay = true;
      if ($.urlParam('autoplay')) {
        autoplay = $.urlParam('autoplay').toLowerCase() === 'true';
      }

      var aggressiveVpaid = true;
      if ($.urlParam('aggressiveVpaid')) {
        aggressiveVpaid = $.urlParam('aggressiveVpaid').toLowerCase() === 'true';
      }

      var vpaid = true;
      if ($.urlParam('vpaid')) {
        vpaid = $.urlParam('vpaid').toLowerCase() === 'true';
      }

      function deselectCustomLoadButton() {
        $(customStreamButton).removeClass('active');
      }

      // NOTE: Doing a deep clone using the JSON stringify/parse
      // does incorrectly clone some objects:
      // https://stackoverflow.com/a/122704
      //
      // In general we're deep cloning the events to ensure no lower level
      // state mutations are picked up later and the console log
      // output incorrectly represents the data
      var cloneDeepSimple = function (obj) {
        return JSON.parse(JSON.stringify(obj));
      };

      function overrideSourceAdKvps(source) {
        var overrideEl = document.getElementById('tearsheet-override');
        if (overrideEl.value === '0') {
          return source;
        }

        source.hls = source.hls + '&tearsheet=' + overrideEl.value;
        return source;
      }

      closePlayerButton.on('click', function () {
        closePlayerButton.button('toggle');
        deselectCustomLoadButton();

        yospacePlayer.unload();
      });

      vodButton.on('click', function () {
        vodButton.button('toggle');
        deselectCustomLoadButton();

        yospacePlayer.unload();
        yospacePlayer.load(vodSource);
      });

      trueXButton.on('click', function () {
        trueXButton.button('toggle');
        deselectCustomLoadButton();

        yospacePlayer.unload();
        yospacePlayer.load(trueXSource);
      });

      liveButton.on('click', function () {
        liveButton.button('toggle');
        deselectCustomLoadButton();

        yospacePlayer.unload();
        yospacePlayer.load(liveSource);
      });

      artOfMotionButton.on('click', () => {
        artOfMotionButton.button('toggle');
        deselectCustomLoadButton();

        yospacePlayer.unload();
        yospacePlayer
          .load(artOfMotionSource)
          .then(() => {
            log('[log] Non yospace source loaded');
          })
          .catch(() => {
            log('[log] Loading non yospace source failed');
          });
      });

      customStreamButton.on('click', function () {
        $(customStreamButton).addClass('active');

        // remove active button of group
        $($('.btn-group-toggle .active')[0]).removeClass('active');
        var customSource = {
          title: 'Custom Stream',
          hls: $('#steam-stream-url').val(),
        };

        if (customStreamTypeSelect.val() === '1') {
          customSource.assetType = bitmovin.player.ads.yospace.YospaceAssetType.VOD;
        } else if (customStreamTypeSelect.val() === '2') {
          customSource.assetType = bitmovin.player.ads.yospace.YospaceAssetType.LINEAR;
        }

        yospacePlayer.unload();
        yospacePlayer.load(customSource);
      });

      var adBreakState = {
        abs: 0,
        as: 0,
        af: 0,
        abf: 0,
        ab: null,
        ad: null,
      };

      var liveSource = {
        title: 'Live Stream',
        // dash: "https://csm-e-sdk-validation.bln1.yospace.com/csm/extlive/yosdk01,t2-dash.mpd?yo.av=3", // v0 emsg
        dash: 'https://csm-e-sdk-validation.bln1.yospace.com/csm/extlive/yosdk01,dash.mpd?yo.av=3', // v1 emsg
        // hls: 'https://csm-e-sdk-validation.bln1.yospace.com/csm/extlive/yospace02,hlssample42.m3u8?yo.br=true&yo.av=3',
        // Yospace configuration
        assetType: bitmovin.player.ads.yospace.YospaceAssetType.LINEAR,
      };

      var vodSource = {
        title: 'VOD Stream',
        // hls without preroll
        // hls: 'https://csm-e-sdk-validation.bln1.yospace.com/csm/access/207411697/c2FtcGxlL21hc3Rlci5tM3U4?yo.av=3',
        // hls with preroll
        hls: 'https://csm-e-sdk-validation.bln1.yospace.com/csm/access/156611618/c2FtcGxlL21hc3Rlci5tM3U4?yo.av=3',
        // Yospace configuration
        assetType: bitmovin.player.ads.yospace.YospaceAssetType.VOD,
        truexConfiguration: {},
        // options: {
        //   startOffset: 600
        // }
      };

      var trueXSource = {
        title: 'TrueX Stream',
        hls: 'https://vod-manifests-aka-qa.warnermediacdn.com/csm/tcm/clear/3c3c3c3c3c3c3c3c3c3c3c3c3c3c3c3c/master_cl.m3u8?afid=222591187&caid=2100555&conf_csid=tbs.com_videopage_test&context=182883174&nw=42448&prof=48804%3Amp4_plus_vast_truex&vdur=1800&yo.vp=true',
        // Yospace configuration
        assetType: bitmovin.player.ads.yospace.YospaceAssetType.VOD,
        truexConfiguration: {
          vastConfigUrl:
            'https://qa-get.truex.com/a2a6aa9ae3d7bd9b8b2675781696b28d50ca0736/vast?dimension_1=#e{series.title}&dimension_2=#{slot.position}&dimension_3=#e{asset.title}&dimension_4=#e{asset.id}&dimension_5=truex_sold&stream_id=#{request.videoRandom}&stream_position=preroll&cb=#e{random}',
        },
      };

      var artOfMotionSource = {
        dash: 'https://bitmovin-a.akamaihd.net/content/MI201109210084_1/mpds/f08e80da-bf1d-4e3d-8899-f0f6155f6efa.mpd',
        hls: 'https://bitmovin-a.akamaihd.net/content/MI201109210084_1/m3u8s/f08e80da-bf1d-4e3d-8899-f0f6155f6efa.m3u8',
        progressive:
          'https://bitmovin-a.akamaihd.net/content/MI201109210084_1/MI201109210084_mpeg-4_hd_high_1080p25_10mbits.mp4',
        poster: 'https://bitmovin-a.akamaihd.net/content/MI201109210084_1/poster.jpg',
      };

      var truexAdFree = false;

      var conf = {
        key: '18ca6ad5-9768-4129-bdf6-17685e0d14d2',
        playback: {
          muted: false,
          autoplay: autoplay, // Fix for Pre-roll 'blip' does not work with autoplay enabled
        },
        logs: {
          level: 'none',
          bitmovin: !isValidationMode,
        },
        ui: false,
        tweaks: {
          enable_seek_for_live: true,
          resume_live_content_at_previous_position_after_ad_break: true,
          FAIRPLAY_IGNORE_DUPLICATE_INIT_DATA_KEY_ERRORS: true,
        },
      };

      // Yospace configuration
      var yospaceConfig = {
        debug: debugOverride && !isValidationMode,
        debugYospaceSdk: isValidationMode,
        disableStrictBreaks: false,
        disableServiceWorker: false,
      };

      var sampleYospacePlayerPolicy = {
        canMute: () => {
          return true;
        },
        canSeek: () => {
          return true;
        },
        canSeekTo: (seekTarget) => {
          return seekTarget;
        },
        canSkip: () => {
          return true;
        },
        canPause: () => {
          return true;
        },
        canChangePlaybackSpeed: () => {
          return true;
        },
      };

      var setupTable = function () {
        var table = $('#adEventTable');
        var header = $('<thead/>');
        // var row = $('<tr/>')
        var row2 = $('<tr/>');
        row2.append($('<th/>').text('AdBreakStart'));
        row2.append($('<th/>').text('AdStart'));
        row2.append($('<th/>').text('AdFinished'));
        row2.append($('<th/>').text('AdBreakFinished'));
        header.append(row2);
        table.append(header);
      };

      var updateAdEventTable = function () {
        if (adBreakState.abs > 0) {
          var table = $('#adEventTable');
          let body = $('<tbody/>');
          $('#adEventTable tbody').remove();
          table.append(body);
          var row = $('<tr>');
          row.append($('<td/>').text(adBreakState.abs));
          row.append($('<td/>').text(adBreakState.as));
          row.append($('<td/>').text(adBreakState.af));
          row.append($('<td/>').text(adBreakState.abf));
          body.append(row);
        }
      };

      setupTable();
      unregisterServiceWorkersPromise.then(() => {
        bitmovin.player.core.Player.addModule(window.bitmovin.player['polyfill'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['style'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['xml'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['advertising-core'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['advertising-bitmovin'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['engine-bitmovin'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['mserenderer'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['hls'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['dash'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['abr'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['container-ts'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['container-mp4'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['engine-native'].default);

        if (!yospaceConfig.disableServiceWorker) {
          bitmovin.player.core.Player.addModule(window.bitmovin.player['serviceworker-client'].default);
        }

        if (yospaceConfig.useTizen) {
          bitmovin.player.core.Player.addModule(window.bitmovin.player['tizen'].default);
        }
        if (yospaceConfig.useWebos) {
          bitmovin.player.core.Player.addModule(window.bitmovin.player['webos'].default);
        }

        var playerContainer = document.getElementById('player');
        yospacePlayer = new bitmovin.player.ads.yospace.BitmovinYospacePlayer(
          bitmovin.player.core.Player,
          playerContainer,
          conf,
          yospaceConfig
        );

        var uiManager = new bitmovin.playerui.UIFactory.buildDefaultUI(yospacePlayer);

        yospacePlayer.on('sourceloaded', function (event) {
          log('[BYP] sourceloaded ', cloneDeepSimple(event));

          yospacePlayer.ads.list().forEach(function (adBreak) {
            uiManager.addTimelineMarker({ time: adBreak.scheduleTime, title: 'Ad Break' });
          });
        });

        yospacePlayer.on('ready', function (event) {
          log('[BYP] ready ', cloneDeepSimple(event));

          if (!autoplay) {
            yospacePlayer.play();
          }
        });

        yospacePlayer.on('moduleready', function (event) {
          log('[BYP] moduleready ', cloneDeepSimple(event));
        });

        yospacePlayer.on('aderror', function (event) {
          console.error('[BYP] AdError ', cloneDeepSimple(event));
        });

        yospacePlayer.on('playing', function (event) {
          log('[BYP] playing ', cloneDeepSimple(event));
        });

        yospacePlayer.on('yospaceerror', function (event) {
          console.error('[BYP] yospaceerror ', cloneDeepSimple(event));
        });

        yospacePlayer.on('metadata', function (event) {
          log('[BYP] Metadata: ', cloneDeepSimple(event));
        });

        yospacePlayer.on('metadataparsed', function (event) {
          log('[BYP] Metadata Parsed: ', cloneDeepSimple(event));
        });

        yospacePlayer.setPolicy(sampleYospacePlayerPolicy);

        yospacePlayer.on('segmentplayback', function (event) {
          if (event.mimeType === 'video/mp4') {
            let segmentUrl = event.url;
            let fileNameIndex = segmentUrl.lastIndexOf('/') + 1;

            var filename = segmentUrl.substr(fileNameIndex);
            $('#segmentPlaybackLabel').text(
              'Segment: url=' +
                filename +
                ' currentTime=' +
                yospacePlayer.getCurrentTime() +
                ' event.playbackTime=' +
                event.playbackTime +
                ' ms=' +
                event.mediaSequenceNumber +
                ' ds=' +
                event.discontinuitySequenceNumber
            );
          }
        });

        yospacePlayer.on('adskipped', function (event) {
          debug('[BYP] Ad Skipped: ', cloneDeepSimple(event));
        });

        yospacePlayer.on('truexadfree', function (event) {
          truexAdFree = true;
          debug(event);
          const seekPosition = adBreakState.ab.scheduleTime + 1;
          console.warn('TrueXAdFree Seeking to ' + seekPosition);
          yospacePlayer.forceSeek(seekPosition);
        });

        yospacePlayer.on('adstarted', function (event) {
          debug('[BYP] Ad Started: ', cloneDeepSimple(event));
          adBreakState.as++;
          adBreakState.ad = event.ad;
          updateAdEventTable();

          if (event.ad && event.ad.companionAds && event.ad.companionAds.length > 0) {
            var linkElement = document.createElement('a');
            linkElement.href = event.ad.companionAds[0].companionClickThroughURLTemplate;
            var img = new Image(event.ad.companionAds[0].width, event.ad.companionAds[0].height);
            img.src = event.ad.companionAds[0].resource.url;
            linkElement.appendChild(img);
            document.getElementById('companionDiv').appendChild(linkElement);
          }

          let activeAdBreak = yospacePlayer.ads.getActiveAdBreak();
          let activeAd = yospacePlayer.ads.getActiveAd();

          debug('[BYP] Active Ad Break: ', cloneDeepSimple(activeAdBreak));
          var table = $('#adTable');
          var header = $('<thead/>');
          // var row = $('<tr/>')
          var row2 = $('<tr/>');
          row2.append($('<th/>').text('Id'));
          row2.append($('<th/>').text('Duration'));
          row2.append($('<th/>').text('VPAID'));
          row2.append($('<th/>').text('Sequence'));
          header.append(row2);
          table.append(header);
          let body = $('<tbody/>');
          table.append(body);
          for (let i = 0; i < activeAdBreak.ads.length; i++) {
            let ad = activeAdBreak.ads[i];
            var row = $('<tr>');
            row.append($('<td/>').text(ad.id));
            row.append($('<td/>').text(ad.duration));
            row.append($('<td/>').text(!ad.uiConfig.requestsUi));
            row.append($('<td/>').text(ad.sequence));
            if (ad.id === activeAd.id && ad.sequence === activeAd.sequence) {
              row.addClass('table-active');
            }

            body.append(row);
          }
        });

        yospacePlayer.on('adfinished', function (event) {
          log('[BYP] Ad Finished: ', cloneDeepSimple(event));
          adBreakState.af++;
          updateAdEventTable();
          var companion = document.getElementById('companionDiv');
          while (companion.firstChild) {
            companion.removeChild(companion.firstChild);
          }

          $('#adTable tbody').remove();
          $('#adTable thead').remove();
        });

        yospacePlayer.on('adbreakfinished', function (event) {
          debug('[BYP] Ad Break Finished: ', cloneDeepSimple(event));
          adBreakState.abf++;
          updateAdEventTable();
        });

        yospacePlayer.on('adbreakstarted', function (event) {
          debug('[BYP] Ad Break Started: ', cloneDeepSimple(event));
          adBreakState.abs++;
          adBreakState.ab = event.adBreak;
          updateAdEventTable();
        });

        yospacePlayer.on('playbackfinished', function (event) {
          debug('[BYP] Playback Finished: ', cloneDeepSimple(event));

          yospacePlayer.unload();
        });

        yospacePlayer.on('timechanged', function (event) {
          if (debugOverride) {
            // This log is noisy, only output when debug is enabled
            log('[BYP] Time Changed: ', cloneDeepSimple(event));
          }
          let adBreak = yospacePlayer.ads.getActiveAdBreak();
          let ad = yospacePlayer.ads.getActiveAd();

          if (adBreak && ad) {
            let duration = adBreak.duration;
            let adCounter = 0;
            let adDuration = 0;
            for (let i = 0; i < adBreak.ads.length; i++) {
              adCounter = i + 1;
              let a = adBreak.ads[i];
              if (a.id === ad.id && ad.sequence === a.sequence) {
                adDuration = a.duration - event.time;
                duration = duration - event.time;
                break;
              } else {
                duration = duration - a.duration;
              }
            }

            $('#adBreakLabel').text('AdBreak: ' + Number(duration).toFixed(2) + 's remaining');
            $('#adLabel').text(
              'Ad ' + adCounter + ' of ' + adBreak.ads.length + ': ' + Number(adDuration).toFixed(2) + 's remaining'
            );
          } else {
            $('#adBreakLabel').text('AdBreak: false');
            $('#adLabel').text('Ad: false');
          }
        });
      });
    </script>
  </body>
</html>
