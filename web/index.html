<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Bitmovin Player Yospace Integration Test Page</title>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- <SCRIPT_PLACEHOLDER> -->

    <!-- Bitmovin Player -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" />
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

    <script type="text/javascript" src="js/bitmovin-player-yospace.js"></script>

    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-core.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-polyfill.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-style.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-xml.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-advertising-core.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-advertising-bitmovin.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-mserenderer.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-engine-bitmovin.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-container-mp4.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-hls.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-dash.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-abr.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-container-ts.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-crypto.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-drm.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-engine-native.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-serviceworker-client.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-tizen.js"></script>
    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/modules/bitmovinplayer-webos.js"></script>

    <script type="text/javascript" src="https://cdn.bitmovin.com/player/web/8/bitmovinplayer-ui.js"></script>
    <link rel="stylesheet" href="https://cdn.bitmovin.com/player/web/8/bitmovinplayer-ui.css" />

    <script type="text/javascript" src="js/simplePolicy.js"></script>
    <script type="text/javascript" src="js/sources.js"></script>

    <script type="text/javascript" src="platformSpecificInit.js"></script>

    <style>
      .player-wrapper {
        margin: 20px auto;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
      }

      .meta-info {
        text-align: center;
      }

      .row {
        margin: 20px 0;
      }

      #companionDiv {
        width: 728px;
        height: 90px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="meta-info">
        <div class="row">
          <div class="col-12">
            <div id="predefined-sources" class="btn-group btn-group-toggle flex-wrap" data-toggle="buttons">
              <button class="btn btn-outline-secondary" type="button" data-toggle="collapse" data-target="#collapsable-customization">
                üõ†Ô∏è Customize asset
              </button>
              <label class="btn btn-outline-secondary" id="option-close">
                <input type="radio" name="options" autocomplete="off" checked />‚úñÔ∏è Close Player
              </label>
            </div>
          </div>
        </div>

        <div class="collapse" id="collapsable-customization">
          <div class="row">
            <div class="col">
              <div class="input-group mb-3">
                <input
                  id="steam-stream-url"
                  type="text"
                  class="form-control"
                  placeholder="Custom Stream URL"
                  aria-label="Custom Stream URL"
                />
                <select class="custom-select col-2" id="stream-type-select">
                  <option value="1">VoD</option>
                  <option value="2">Live (deprecated)</option>
                  <option value="3">DVRLive</option>
                  <option value="4">None</option>
                </select>
                <div class="input-group-append">
                  <button id="load-custom-steam" class="btn btn-outline-secondary" type="button">Load</button>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="input-group mb-3">
                <select class="custom-select col-12" id="tearsheet-override">
                  <option value="0" selected>Override Ad Tearsheet</option>
                  <option value="55085793" data-id="141403_CNN_Fuji_VPAID_30s_307518956_6.30">55085793 - Fuji Film 30s</option>
                  <option value="54510215" data-id="139334_CNN_Invesco_Markets_VPAID_15s_306893272_6.28.21">
                    54510215 - Invesco Limited 15s
                  </option>
                  <option value="54510215" data-id="139334_CNN_Invesco_Markets_VPAID_15s_306893272_6.28.21">
                    54510215 - Invesco Limited 30s
                  </option>
                  <option value="52125737" data-id="138227_CNN_IBM CA Cash_Desktop_15s_VPAID_289436970_NEW_2.25.21">
                    52125737 - IBM Corp 15s
                  </option>
                  <option value="54476788" data-id="141744_CNN_Farmers_Q3_15s_VPAID_2371065_6.24.21">54476788 - Farmers 15s</option>
                  <option value="54476788" data-id="141744_CNN_Farmers_Q3_30s_VPAID_2371066_6.24.21">54476788 - Farmers 30s</option>
                  <option value="50323493" data-id="138527_CNN_ROS_Tobacco_Free_Kids_293007205_VPAID_30s_1.7">
                    50323493 - Tobacco Free Kids 30s
                  </option>
                  <option value="49929643" data-id="138222_CNN_IBM CA_VPAID_289542595_15s_NEW_2.25.21">49929643 - IBM Corp-2 30s</option>
                  <option value="55085793" data-id="141403_CNN_Fuji_Vpaid_with_mp4_30_307581174_7.1">55085793 - Fuji Film-2 30s</option>
                  <option value="51153356" data-id="141403_CNN_Fuji_Vpaid_with_mp4_30_307581174_7.1">
                    51153356 - Association of AM Railroads 15s
                  </option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="content">
        <div class="player-wrapper">
          <div id="player"></div>
        </div>
      </div>

      <div class="row">
        <div class="col-9">
          <p1 id="segmentPlaybackLabel">Playing Segment: unknown</p1>
        </div>
        <div class="col-3">
          <label class="btn btn-outline-secondary" id="toggle-ad-immunity"> Enable Ad Immunity (60sec) </label>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <p1 id="adBreakLabel">AdBreak: false</p1>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <p1 id="adLabel">Ad: false</p1>
        </div>
      </div>

      <div class="row">
        <table class="table" id="adEventTable"></table>
      </div>

      <div class="row">
        <table class="table" id="adTable"></table>
      </div>
      <div class="row">
        <div id="companionDiv"></div>
      </div>
    </div>
    <script type="text/javascript">
      /* queryParameters */

      /**
       * validation = true|false
       *
       * Should be used to enable Yospace SDK logs (and disable other logs) for validating the yospace integration at
       * https://developer.yospace.com/sdk-documentation/javascript/userguide/yosdk/latest/en/validate-your-app.html
       */
      var isValidationMode = false;

      /**
       * debug = true|false
       */
      var debugOverride = true;

      /**
       * autoplay = true|false
       */
      var autoplay = true;

      /**
       * aggressiveVpaid = true|false
       */
      var aggressiveVpaid = true;

      /**
       * vpaid = true|false
       */
      var vpaid = true;

      /**
       * autoLoadSource = <number>
       *
       * Automatically load a pre-defined source into the player after loading the sample page.
       * Index starts at 1.
       */
      var autoLoadSource = platformType !== 'web' ? 1 : -1;

      /* end of queryParameters */


      var bitmovinPlayerLicenseKey = 'YOUR-KEY';

      var yospacePlayer;
    </script>
    <script type="text/javascript" src="js/pageSetup.js"></script>
    <script type="text/javascript">
      var adBreakState = {
        abs: 0,
        as: 0,
        af: 0,
        abf: 0,
        ab: null,
        ad: null,
      };

      var truexAdFree = false;

      var conf = {
        key: bitmovinPlayerLicenseKey,
        playback: {
          muted: false,
          autoplay: autoplay, // Fix for Pre-roll 'blip' does not work with autoplay enabled
        },
        logs: {
          level: 'none',
          bitmovin: !isValidationMode,
        },
        ui: false,
        tweaks: {
          FAIRPLAY_IGNORE_DUPLICATE_INIT_DATA_KEY_ERRORS: true,
        },
      };

      conf = updateWithPlatformSpecificConfig(conf);

      // Yospace configuration
      var yospaceConfig = {
        debug: debugOverride && !isValidationMode,
        debugYospaceSdk: isValidationMode,
        disableServiceWorker: false,
        useTizen: platformType === 'tizen',
        useWebos: platformType === 'webos',
      };

      platformReadyForPlayerPromise.then(() => {
        bitmovin.player.core.Player.addModule(window.bitmovin.player['polyfill'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['style'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['xml'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['advertising-core'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['advertising-bitmovin'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['engine-bitmovin'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['mserenderer'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['hls'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['dash'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['abr'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['container-ts'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['container-mp4'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['crypto'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['drm'].default);
        bitmovin.player.core.Player.addModule(window.bitmovin.player['engine-native'].default);

        if (!yospaceConfig.disableServiceWorker) {
          bitmovin.player.core.Player.addModule(window.bitmovin.player['serviceworker-client'].default);
        }

        if (yospaceConfig.useTizen) {
          bitmovin.player.core.Player.addModule(window.bitmovin.player['tizen'].default);
        }
        if (yospaceConfig.useWebos) {
          bitmovin.player.core.Player.addModule(window.bitmovin.player['webos'].default);
        }

        var playerContainer = document.getElementById('player');
        yospacePlayer = new bitmovin.player.ads.yospace.BitmovinYospacePlayer(
          bitmovin.player.core.Player,
          playerContainer,
          conf,
          yospaceConfig
        );

        var uiManager = new bitmovin.playerui.UIFactory.buildDefaultUI(yospacePlayer);

        yospacePlayer.on('sourceloaded', function (event) {
          log(createLogFromEvent(event));

          yospacePlayer.ads.list().forEach(function (adBreak) {
            uiManager.addTimelineMarker({ time: adBreak.scheduleTime, title: 'Ad Break' });
          });
        });

        yospacePlayer.on('ready', function (event) {
          log(createLogFromEvent(event));

          if (!autoplay) {
            yospacePlayer.play();
          }
        });

        ['adskipped', 'moduleready', 'playing', 'metadata', 'metadataparsed'].forEach(function (eventName) {
          yospacePlayer.on(eventName, function (event) {
            debug(createLogFromEvent(event));
          });
        });

        ['moduleready', 'playing', 'metadata', 'metadataparsed', 'adimmunitystarted', 'adimmunityended'].forEach(function (eventName) {
          yospacePlayer.on(eventName, function (event) {
            log(createLogFromEvent(event));
          });
        });

        ['error', 'yospaceerror', 'policyerror', 'aderror'].forEach(function (eventName) {
          yospacePlayer.on(eventName, function (event) {
            console.error(createLogFromEvent(event));
          });
        });

        // We are using the default, built-in policy in the demo. Another policy can easily be set using this method:
        // yospacePlayer.setPolicy(simplePolicy);

        yospacePlayer.on(bitmovin.player.ads.yospace.YospacePlayerEvent.AdImmunityEnded, adImmunityEndedEventHandler);

        yospacePlayer.on(bitmovin.player.ads.yospace.YospacePlayerEvent.AdImmunityStarted, adImmunityStartedEventHandler);

        yospacePlayer.on('segmentplayback', function (event) {
          if (event.mimeType === 'video/mp4') {
            let segmentUrl = event.url;
            let fileNameIndex = segmentUrl.lastIndexOf('/') + 1;

            var filename = segmentUrl.substr(fileNameIndex);
            $('#segmentPlaybackLabel').text(
              'Segment: url=' +
                filename +
                ' currentTime=' +
                yospacePlayer.getCurrentTime() +
                ' event.playbackTime=' +
                event.playbackTime +
                ' mediaSequenceNumber=' +
                event.mediaSequenceNumber +
                ' discontinuitySequenceNumber=' +
                event.discontinuitySequenceNumber
            );
          }
        });

        yospacePlayer.on('truexadfree', function (event) {
          truexAdFree = true;
          debug(createLogFromEvent(event));
          const seekPosition = adBreakState.ab.scheduleTime + 1;
          console.warn('TrueXAdFree Seeking to ' + seekPosition);
          yospacePlayer.forceSeek(seekPosition);
        });

        yospacePlayer.on('adstarted', function (event) {
          debug(createLogFromEvent(event));
          adBreakState.as++;
          adBreakState.ad = event.ad;
          updateAdEventTable();

          displayCompanionAd(event);

          let activeAdBreak = yospacePlayer.ads.getActiveAdBreak();
          let activeAd = yospacePlayer.ads.getActiveAd();

          debug('[BYP] Active Ad Break: ', cloneDeepSimple(activeAdBreak));
          adStartedHandler(activeAdBreak, activeAd);
        });

        yospacePlayer.on('adfinished', function (event) {
          log(createLogFromEvent(event));
          adBreakState.af++;
          updateAdEventTable();
          hideCompanionAd();

          $('#adTable tbody').remove();
          $('#adTable thead').remove();
        });

        yospacePlayer.on('adbreakfinished', function (event) {
          debug(createLogFromEvent(event));
          adBreakState.abf++;
          updateAdEventTable();
        });

        yospacePlayer.on('adbreakstarted', function (event) {
          debug(createLogFromEvent(event));
          adBreakState.abs++;
          adBreakState.ab = event.adBreak;
          updateAdEventTable();
        });

        yospacePlayer.on('playbackfinished', function (event) {
          debug(createLogFromEvent(event));
          yospacePlayer.unload();
        });

        yospacePlayer.on('timechanged', function (event) {
          if (debugOverride) {
            // This log is noisy, only output when debug is enabled
            log(createLogFromEvent(event));
          }

          timeChangedAdHandler(yospacePlayer.ads.getActiveAdBreak(), yospacePlayer.ads.getActiveAd(), event.time);
        });

        if (autoLoadSource > -1) {
          var sourceList = document.querySelector('#predefined-sources');
          if (autoLoadSource < sourceList.childElementCount - 1) {
            sourceList.children[autoLoadSource + 1].children[0].click();
          }
        }
      });
    </script>
  </body>
</html>
